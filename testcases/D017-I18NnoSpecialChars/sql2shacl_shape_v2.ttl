@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix sh: <http://www.w3.org/ns/shacl#> .
@prefix uq: <http://sirius−labs.no/shapes/unique#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .

<http://example.com/base/成分> a rdfs:Class,
        sh:NodeShape ;
    sh:property [ sh:class <http://example.com/base/植物> ;
            sh:maxCount 1 ;
            sh:nodeKind sh:IRI ;
            sh:path <http://example.com/base/成分,植物#植物名,使用部,名,使用部> ],
        [ sh:datatype xsd:string ;
            sh:maxCount 1 ;
            sh:nodeKind sh:Literal ;
            sh:path <http://example.com/base/成分#使用部> ],
        [ sh:datatype xsd:string ;
            sh:maxCount 1 ;
            sh:nodeKind sh:Literal ;
            sh:path <http://example.com/base/成分#皿> ],
        [ sh:datatype xsd:string ;
            sh:maxCount 1 ;
            sh:nodeKind sh:Literal ;
            sh:path <http://example.com/base/成分#植物名> ] .

<http://example.com/base/植物> a rdfs:Class,
        sh:NodeShape ;
    uq:uniqueValuesForClass [ uq:unqForClass <http://example.com/base/植物> ;
            uq:unqProp <http://example.com/base/植物#使用部>,
                <http://example.com/base/植物#名> ] ;
    sh:property [ sh:datatype xsd:string ;
            sh:maxCount 1 ;
            sh:minCount 1 ;
            sh:nodeKind sh:Literal ;
            sh:path <http://example.com/base/植物#使用部> ],
        [ sh:datatype xsd:string ;
            sh:maxCount 1 ;
            sh:minCount 1 ;
            sh:nodeKind sh:Literal ;
            sh:path <http://example.com/base/植物#名> ],
        [ sh:class <http://example.com/base/成分> ;
            sh:nodeKind sh:IRI ;
            sh:path [ sh:inversePath <http://example.com/base/成分,植物#植物名,使用部,名,使用部> ] ],
        [ sh:datatype xsd:string ;
            sh:maxCount 1 ;
            sh:nodeKind sh:Literal ;
            sh:path <http://example.com/base/植物#条件> ] .

uq:UniqueValuesConstraintComponent a sh:ConstraintComponent ;
    sh:nodeValidator [ a sh:SPARQLSelectValidator ;
            sh:select """
            PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
            PREFIX uq: <http://sirius−labs.no/shapes/unique#>

            SELECT $this ?other
            WHERE { 
                FILTER NOT EXISTS {
                    GRAPH $shapesGraph {
                        $uniqueValuesForClass uq:unqProp ?prop
                    }
                    $this ?prop ?thisVal .
                    ?other ?prop ?otherVal .
                    FILTER (?thisVal != ?otherVal)
                }
                FILTER (?other != $this)
                GRAPH $shapesGraph {
                    $uniqueValuesForClass uq:unqForClass ?class
                } 
                ?other rdf:type $class .
            }
        """ ] ;
    sh:parameter [ sh:path uq:uniqueValuesForClass ] .

